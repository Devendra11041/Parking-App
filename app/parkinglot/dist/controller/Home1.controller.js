sap.ui.define(["./Basecontroller","sap/ui/model/json/JSONModel","sap/ui/Device","sap/m/MessageToast","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/format/DateFormat","sap/ui/model/odata/v2/ODataModel","sap/m/MessageBox"],function(e,t,a,o,i,r,s,n,l,c){"use strict";return e.extend("com.app.parkinglot.controller.Home1",{onInit:function(){var e=new t(sap.ui.require.toUrl("com/app/parkinglot/model/data.json"));this.getView().setModel(e);var a=new sap.ui.model.json.JSONModel({Notifications:[]});this.getView().setModel(a,"NotificationModel");this._setParkingLotModel();this._setHistoryModel();this.loadParkingLots();var o=new Date;var i=new Date(o);i.setDate(o.getDate());var r=this.getView().byId("idinputdatepicker");r.setMinDate(i);r.setDisplayFormat("yyyy-MM-dd");const s=new sap.ui.model.json.JSONModel({vehicleTypes:[{key:"inward",text:"inward"},{key:"outward",text:"outward"}]});this.getView().setModel(s,"vehicleTypeModel");const n=new t({VehicalDeatils:{vehicalNo:"",driverName:"",phone:"",vehicalType:"",assignedDate:"",unassignedDate:"",plotNo_plot_NO:""},plotNo:{available:false}});this.getView().setModel(n,"localModel");var l=this.getOwnerComponent().getModel("ModelV2");if(l){this.getView().byId("pageContainer").setModel(l)}},onItemSelect:function(e){var t=e.getParameter("item");this.byId("pageContainer").to(this.getView().createId(t.getKey()))},onExit:function(){a.media.detachHandler(this._handleMediaChange,this)},statusTextFormatter:function(e){return e?"Empty":"Not Empty"},onValueHelpRequest:function(e){var t=e.getSource().getValue(),a=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=i.load({id:a.getId(),name:"com.app.parkinglot.fragment.valuhelp",controller:this}).then(function(e){a.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.setModel(this.getView().getModel("ModelV2"));e.getBinding("items").filter([new r("plot_NO",n.Contains,t)]);e.open(t)}.bind(this))},onValueHelpDialogSearch:function(e){var t=e.getParameter("value");var a=new r("plot_NO",n.Contains,t);e.getSource().getBinding("items").filter([a])},onValueHelpDialogClose:function(e){var t,a=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!a){return}t=a.getDescription();this.byId("productInput").setSelectedKey(t)},onAssignPress:async function(){debugger;const e=this.getView().byId("page1").getModel("localModel").getProperty("/");const{driverName:t,phone:a,vehicalNo:i}=this.getView().byId("page1").getModel("localModel").getProperty("/").VehicalDeatils;const r=this.getView().byId("idselectvt").getSelectedKey();const s=this.getView().byId("pageContainer").getModel("ModelV2");const n=this.getView().byId("productInput").getValue();e.VehicalDeatils.plotNo_plot_NO=n;e.VehicalDeatils.vehicalType=r;const l=new Date;e.VehicalDeatils.assignedDate=l;if(!(t&&a&&i&&r&&n)){o.show("Enter all details");return}var c=a.trim();var d=/^(?:(?:\+|0{0,2})91(\s*[\-]\s*)?|[0]?)?[6789]\d{9}$/;if(!d.test(c)){o.show("Please enter a valid phone number");return}var u=/^[A-Z]{2}[0-9]{2}[A-Z]{2}[0-9]{4}$/;if(!u.test(i)){o.show("Please check Vehicle Number Once");return}debugger;var h=await this.checkVehicleNo(s,e.VehicalDeatils.vehicalNo);if(h){o.show("Vehicle already exsist");return}var g=await this.checkPhoneExists(s,c);if(g){sap.m.MessageBox.error("Phone number already associated with another vehicle Please Check mobile number");return}var p=await this.plotnoexists(s,n);if(!p){o.show("Please Select Valid Plotn No");return}try{await this.createData(s,e.VehicalDeatils,"/VehicalDeatils");const v="ACfcd333bcb3dc2c2febd267ce455a6762";const m="ea44ceea6205dd2864f4b5beb40d31c0";const w=`+91${a}`;const f="+13613109079";const y=`Hi ${t} a Slot number ${n} is alloted to you vehicle number ${i} \nKindly Move your vehicle to your allocated Parking lot. \nThank You,\nVishal Parking Management.`;const b="";$.ajax({url:b,type:"POST",async:true,headers:{Authorization:"Basic "+btoa(v+":"+m)},data:{To:w,From:f,Body:y},success:function(e){o.show("if number exists SMS will be sent!")},error:function(e){o.show("Failed to send SMS: "+e)}});function V(e,t="en-US"){if("speechSynthesis"in window){var a=new SpeechSynthesisUtterance(e);a.pitch=1;a.rate=.75;a.volume=1;a.lang=t;debugger;window.speechSynthesis.speak(a)}else{console.log("Sorry, your browser does not support the Web Speech API.")}}V(`దయచేసి వినండి. వాహనం నంబర్ ${i} కు స్లాట్ నంబర్ ${n} కేటాయించబడింది.`,"te-IN");var h=await this.checkVehicleNo(s,e.VehicalDeatils.vehicalNo);sap.m.MessageToast.show(`Vehicel No ${i} allocated to Slot No ${n}`);s.update("/PlotNOs('"+n+"')",e.plotNo,{success:function(){}.bind(this),error:function(e){sap.m.MessageBox.error("Failed to update: "+e.message)}.bind(this)});this.triggerPrintForm(e.VehicalDeatils)}catch(N){console.error("Error:",N)}this.onclearvalues()},checkPhoneExists:async function(e,t){return new Promise((a,o)=>{e.read("/VehicalDeatils",{filters:[new sap.ui.model.Filter("phone",sap.ui.model.FilterOperator.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking phone number existence.")}})})},checkVehicleNo:async function(e,t){return new Promise((a,o)=>{e.read("/VehicalDeatils",{filters:[new sap.ui.model.Filter("vehicalNo",sap.ui.model.FilterOperator.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking vehicle number existence.")}})})},plotnoexists:async function(e,t){return new Promise((a,o)=>{e.read("/PlotNOs",{filters:[new sap.ui.model.Filter("plot_NO",sap.ui.model.FilterOperator.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking vehicle number existence.")}})})},checkReservation:async function(e,t){return new Promise((a,o)=>{e.read("/Reservation",{filters:[new sap.ui.model.Filter("vehicalNo",sap.ui.model.FilterOperator.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking parking lot reservation.")}})})},checkPlotEmpty:async function(e,t){return new Promise((a,o)=>{e.read("/VehicalDeatils",{filters:[new r("vehicalNo",n.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking username existence.")}})})},onclearvalues:function(){var e=this.getView().getModel("localModel");e.setProperty("/VehicalDeatils",{vehicalNo:"",driverName:"",phone:"",vehicalType:"",plotNo_plot_NO:""});this.getView().byId("productInput").setValue("")},onUnassignPress1:async function(){const e=this;const t=this.getView().byId("page1").getModel("localModel").getProperty("/");const{driverName:a,phone:i,vehicalNo:r,vehicalType:s}=this.getView().byId("page1").getModel("localModel").getProperty("/").VehicalDeatils;const n=this.getView().byId("pageContainer").getModel("ModelV2");const l=this.getView().byId("productInput").getValue();t.VehicalDeatils.plotNo_plot_NO=l;const c=new Date;t.VehicalDeatils.unassignedDate=c;try{await e.createData(n,t.VehicalDeatils,"/History");await e.deleteData(n,"/VehicalDeatils",r);const s="";const c="";const d=`+91${i}`;const u="+13613109079";const h=`Hi ${a},\n\nYour vehicle with registration number ${r} was previously parked in Slot number ${l}.Please remove your vehicle from the parking lot at your earliest convenience..\n\nPlease ignore this message if you have already removed your vehicle from the parking lot.\n\nThank you,\nVishal Parking Management.`;const g="";$.ajax({url:g,type:"POST",async:true,headers:{Authorization:"Basic "+btoa(s+":"+c)},data:{To:d,From:u,Body:h},success:function(e){o.show("if number exists SMS will be sent!")},error:function(e){o.show("Failed to send SMS: "+e)}});const p={available:true};n.update("/PlotNOs('"+l+"')",p,{success:function(){sap.m.MessageToast.show(`Vehicle ${r} unassigned and parking lot ${l} is now available`)},error:function(e){sap.m.MessageBox.error("Failed to update : "+e.message)}});this.onclearvalues()}catch(e){sap.m.MessageBox.error("Some technical Issue")}},OnPrintpress:async function(){debugger;var e=this.byId("AssignedSlotsTable").getSelectedItems();if(e.length===0){l.error("Please Select atleast one Book to Edit");return}var t=e[0];if(t){var a=t.getBindingContext().getProperty("vehicalNo");var o=t.getBindingContext().getProperty("driverName");var r=t.getBindingContext().getProperty("phone");var s=t.getBindingContext().getProperty("vehicalType");var n=t.getBindingContext().getProperty("assignedDate");var c=t.getBindingContext().getProperty("plotNo")}if(!this.oprint){this.oprint=await i.load({id:this.getView().getId(),name:"com.app.parkinglot.fragment.print",controller:this});this.getView().addDependent(this.oprint)}this.oprint.open()},onCloseDialog:function(){var e=this.byId("idprintparking");if(e){e.close()}},vehiclesubmit:function(e){debugger;const t=this.getView().byId("page1").getModel("localModel");const a=this.getView().byId("pageContainer").getModel("ModelV2");const o=e.getParameter("value");const i=e=>{t.setProperty("/VehicalDeatils/vehicalNo",e.vehicalNo);t.setProperty("/VehicalDeatils/driverName",e.driverName);t.setProperty("/VehicalDeatils/phone",e.phone);t.setProperty("/VehicalDeatils/vehicalType",e.vehicalType);t.setProperty("/VehicalDeatils/assignedDate",e.assignedDate);this.oView.byId("productInput").setValue(e.plotNo_plot_NO)};const s=()=>{t.setProperty("/VehicalDeatils/vehicalNo","");t.setProperty("/VehicalDeatils/driverName","");t.setProperty("/VehicalDeatils/phone","");t.setProperty("/VehicalDeatils/vehicalType","");t.setProperty("/VehicalDeatils/assignedDate","");t.setProperty("/VehicalDeatils/plotNo_plot_NO","")};a.read("/VehicalDeatils",{filters:[new r("vehicalNo",sap.ui.model.FilterOperator.EQ,o)],success:function(e){var t=e.results;if(t.length>0){var n=t[0];i(n)}else{a.read("/Reservation",{filters:[new r("vehicalNo",sap.ui.model.FilterOperator.EQ,o)],success:function(e){var t=e.results;if(t.length>0){var a=t[0];var o={vehicalNo:a.vehicalNo,driverName:a.driverName,phone:a.phone,vehicalType:a.vehicalType,assignedDate:a.Expectedtime,plotNo_plot_NO:a.plotNo_plot_NO};i(o)}else{sap.m.MessageToast.show("Vehicle number not found.");s()}}.bind(this),error:function(e){sap.m.MessageToast.show("Error fetching reservation details: "+e.message)}})}}.bind(this),error:function(e){sap.m.MessageToast.show("Error fetching vehicle details: "+e.message)}})},onEditpress:function(e){debugger;var t=e.getSource();var a=t.getText();var o=t.getParent();var i=o.getCells()[4];var r=i.getItems()[0];var s=i.getItems()[1];if(a==="Edit"){t.setText("Submit");r.setVisible(false);s.setVisible(true);s.setEditable(true)}else{t.setText("Edit");r.setVisible(true);s.setVisible(false);s.setEditable(false);var n=t.getParent().getBindingContext().getObject().vehicalNo;var l=r.getValue();var c=s.getSelectedKey();var d=this.getView().getModel("ModelV2");var u=this;d.update("/VehicalDeatils('"+n+"')",{plotNo_plot_NO:c},{success:function(){sap.m.MessageToast.show("VehicalDeatils updated successfully!");d.update("/PlotNOs('"+l+"')",{available:true},{success:function(){d.update("/PlotNOs('"+c+"')",{available:false},{success:function(){sap.m.MessageToast.show("PlotNOs updated successfully!");d.refresh(true);u.getView().byId("AssignedSlotsTable").getBinding("items").refresh(true)},error:function(){sap.m.MessageBox.error("Error occurs while updating new plotNo availability!")}})},error:function(){sap.m.MessageBox.error("Error occurs while updating old plotNo availability!")}})},error:function(){sap.m.MessageBox.error("Error occurs while updating VehicalDeatils!")}})}},onReservePressbtn:async function(){debugger;var e=this.getView();const t=e.byId("pageContainer").getModel("ModelV2");var a=e.byId("InputVehicleno").getValue();var i=e.byId("InputDriverName").getValue();var r=e.byId("InputPhonenumber").getValue();var s=e.byId("InputVehicletype").getSelectedKey();var n=e.byId("idcombox1").getValue();var l=e.byId("idinputdatepicker");var c=l.getDateValue();if(!r||!r.match(/^[9876]\d{9}$/)){sap.m.MessageBox.error("Please enter a valid phone number starting with 9, 8, 7, or 6 and exactly 10 digits.");return}var d=/^[A-Z]{2}[0-9]{2}[A-Z]{2}[0-9]{4}$/;if(!d.test(a)){o.show("Please check Vehicle Number Once");return}if(!a||!a.match(/^[\w\d]{1,10}$/)){sap.m.MessageBox.error("Please enter a valid vehicle number (alphanumeric, up to 10 characters).");return}const u=await this.checkVehicleExists(t,a);if(u){sap.m.MessageBox.error("Vehicle number already exists. Please enter a different vehicle number.");return}var h=await this.plotnovalidation(t,n);if(!h){o.show("Please Select Valid Plotn No");return}var g=new sap.ui.model.json.JSONModel({vehicalNo:a,driverName:i,phone:r,vehicalType:s,plotNo_plot_NO:n,Expectedtime:c});this.getView().byId("page8").setModel(g,"newmodel");const p=this.getView().byId("page8").getModel("newmodel").getProperty("/");try{await this.createData(t,p,"/Reservation");sap.m.MessageBox.success("Parking lot reserved  successfully")}catch(e){sap.m.MessageBox.error("Failed to create reservation. Please try again.");console.error("Error creating reservation:",e)}this.onclearreservations()},plotnovalidation:async function(e,t){return new Promise((a,o)=>{e.read("/PlotNOs",{filters:[new sap.ui.model.Filter("plot_NO",sap.ui.model.FilterOperator.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking vehicle number existence.")}})})},checkVehicleExists:async function(e,t){debugger;return new Promise((a,o)=>{e.read("/Reservation",{filters:[new r("vehicalNo",sap.ui.model.FilterOperator.EQ,t)],success:function(e){a(e.results.length>0)},error:function(){o("An error occurred while checking vehicle number existence.")}})})},onclearreservations:function(){this.getView().byId("InputVehicleno").setValue("");this.getView().byId("InputDriverName").setValue("");this.getView().byId("InputPhonenumber").setValue("");this.getView().byId("InputVehicletype").setValue("");this.getView().byId("idcombox1").setValue("");this.getView().byId("idinputdatepicker").setValue("")},onpressassignrd:async function(){debugger;var e=this.byId("ReservationTable").getSelectedItems();if(e.length===0){l.error("Please Select atleast row to Assign");return}var a=this.byId("ReservationTable").getSelectedItem().getBindingContext().getObject();var i=this.byId("ReservationTable").getSelectedItem().getBindingContext().getPath();const r=new Date;var s=new t({vehicalNo:a.vehicalNo,driverName:a.driverName,phone:a.phone,vehicalType:a.vehicalType,assignedDate:r,plotNo_plot_NO:a.plotNo_plot_NO});var n=a.plotNo_plot_NO;const c=this.getView().byId("pageContainer").getModel("ModelV2");debugger;this.getView().byId("page8").setModel(s,"resmodel");this.getView().byId("page8").getModel("resmodel").getProperty("/");c.create("/VehicalDeatils",s.getData(),{success:function(e){debugger;c.remove(i,{success:function(){c.refresh();c.update("/PlotNOs('"+n+"')",{available:false},{success:function(){sap.m.MessageBox.success(`Reserved Vehicle ${a.vehicalNo} assigned successfully to plot ${a.plotNo_plot_NO}.`);c.refresh()},error:function(){sap.m.MessageBox.error("HBJKLJHGVhb")}})},error:function(e){sap.m.MessageBox.error("Failed to update : "+e.message)}});const t="ACfcd333bcb3dc2c2febd267ce455a6762";const r="ea44ceea6205dd2864f4b5beb40d31c0";const s=`+91${a.phone}`;const l="+13613109079";const d=`Hi ${a.driverName},\n\nYour vehicle with registration number ${a.vehicalNo} was previously parked in Slot number ${a.plotNo_plot_NO}.Please remove your vehicle from the parking lot at your earliest convenience..\n\nPlease ignore this message if you have already removed your vehicle from the parking lot.\n\nThank you,\nVishal Parking Management.`;const u=`https://api.twilio.com/2010-04-01/Accounts/${t}/Messages.json`;$.ajax({url:u,type:"POST",async:true,headers:{Authorization:"Basic "+btoa(t+":"+r)},data:{To:s,From:l,Body:d},success:function(e){o.show("if number exists SMS will be sent!")},error:function(e){o.show("Failed to send SMS: "+e)}})},error:function(e){sap.m.MessageBox.error("Failed to update : "+e.message)}})},_setParkingLotModel:function(){var e=this.getOwnerComponent().getModel("ModelV2");var a=this;e.read("/PlotNOs",{success:function(e){console.log("Fetched Data:",e);var o=e.results;var i=o.filter(e=>e.available===true).length;var r=o.filter(e=>e.available===false).length;var s={Items:[{available:true,Count:i,available:`Empty Lots - ${i}`},{available:false,Count:r,available:`Not Empty Lots -${r}`}]};var n=new t;n.setData(s);a.getView().setModel(n,"ParkingLotModel")},error:function(e){console.error(e)}})},_setHistoryModel:function(){debugger;var e=this.getOwnerComponent().getModel("ModelV2");var a=this;e.read("/History",{success:function(e){console.log("Fetched Data:",e);var o=e.results;var i=a._processHistoryData(o);var r=new t;r.setData(i);a.getView().setModel(r,"HistoryModel")},error:function(e){console.error(e)}})},_processHistoryData:function(e){debugger;var t={};e.forEach(function(e){var a=new Date(e.assignedDate).toISOString().split("T")[0];if(!t[a]){t[a]={date:a,inwardCount:0,outwardCount:0,totalVehicle:0}}if(e.vehicalType==="inward"){t[a].inwardCount+=1}else if(e.vehicalType==="outward"){t[a].outwardCount+=1}t[a].totalVehicle=t[a].inwardCount+t[a].outwardCount});return{Items:Object.values(t)}},onSelectData:function(e){var t=e.getParameter("data");if(t&&t.length>0){var a=t[0].data;sap.m.MessageToast.show("Selected Date: "+a.date+"\nInward Count: "+a.inwardCount+"\nOutward Count: "+a.outwardCount)}else{console.error("No data selected or data structure mismatch.")}},handleRenderComplete:function(e){console.log("Chart rendering complete.")},onSearch:function(e){debugger;var t=e.getSource().getValue();var a=this.byId("ReservationTable");var o=a.getBinding("items");if(o){var i=new sap.ui.model.Filter([new r("plotNo_plot_NO",sap.ui.model.FilterOperator.Contains,t),new r("vehicalNo",sap.ui.model.FilterOperator.Contains,t),new r("driverName",sap.ui.model.FilterOperator.Contains,t)],false);o.filter(i)}},OnpressNotify:async function(e){var t=e.getSource(),a=this.getView();if(!this._pPopover){this._pPopover=this.loadFragment("Notification").then(function(e){a.addDependent(e);e.setModel(o);return e})}this._pPopover.then(function(e){e.openBy(t)});var o=this.getOwnerComponent().getModel("ModelV2");this.getView().byId("idnotificationDialog").setModel(o)},loadParkingLots:function(){var e=this.getOwnerComponent().getModel("ModelV2");var t=this.byId("parkingLotContainer");e.read("/PlotNOs",{success:function(e){var a=0;var o=0;e.results.forEach(function(e){if(e.available){a++}else{o++}var i=new sap.m.VBox({width:"100px",height:"100px",alignItems:"Center",justifyContent:"Center",items:[new sap.m.Text({text:e.plot_NO}),new sap.m.Text({text:e.inBoundOroutBound})]}).addStyleClass(e.available?"greenBackground":"redBackground");t.addItem(i)});this.byId("availableCount").setText("("+a+")");this.byId("unavailableCount").setText("("+o+")")}.bind(this),error:function(e){sap.m.MessageToast.show("Error fetching parking lot details.")}})},triggerPrintForm:function(e){debugger;var t=window.open("","","height=500,width=800");t.document.write("<html><head><title>Parking Lot Allocation</title>");t.document.write("<style>body{font-family: Arial, sans-serif;} table{width: 100%; border-collapse: collapse;} td, th{border: 1px solid #ddd; padding: 8px;} th{padding-top: 12px; padding-bottom: 12px; text-align: left; background-color: #4CAF50; color: white;}</style>");t.document.write("</head><body>");t.document.write("<h2>Parking Lot Allocation</h2>");t.document.write("<table><tr><th>Field</th><th>Value</th></tr>");t.document.write("<tr><td>Vehicle Number</td><td>"+e.vehicalNo+"</td></tr>");t.document.write("<tr><td>Driver Name</td><td>"+e.driverName+"</td></tr>");t.document.write("<tr><td>Phone</td><td>"+e.phone+"</td></tr>");t.document.write("<tr><td>Vehicle Type</td><td>"+e.vehicalType+"</td></tr>");t.document.write("<tr><td>Plot Number</td><td>"+e.plotNo_plot_NO+"</td></tr>");t.document.write("<tr><td>Assigned Date</td><td>"+e.assignedDate+"</td></tr>");debugger;const a=`${e.vehicalNo}`;const o=document.createElement("canvas");JsBarcode(o,a,{format:"CODE128",lineColor:"#0aa",width:4,height:40,displayValue:true});const i=o.toDataURL("image/png");t.document.write('<tr><td>Barcode</td><td><img src="'+i+'" alt="Barcode"></td></tr>');t.document.write("</table>");t.document.write("</body></html>");t.document.close();t.print()}})});
//# sourceMappingURL=Home1.controller.js.map